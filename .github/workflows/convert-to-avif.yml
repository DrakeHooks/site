name: Convert images to AVIF

on:
  push:
    branches:
      - main
    paths:
      - "static/**/*"
      - "content/**/*"
      - ".github/workflows/convert-to-avif.yml"

jobs:
  convert:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # allow committing generated AVIFs back

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install sharp
        run: |
          npm init -y
          npm install sharp@latest

      - name: Convert images to AVIF
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const sharp = require('sharp');

          const exts = ['.jpg', '.jpeg', '.png'];

          function walk(dir, fileList = []) {
            if (!fs.existsSync(dir)) return fileList;
            const entries = fs.readdirSync(dir, { withFileTypes: true });
            for (const entry of entries) {
              const fullPath = path.join(dir, entry.name);
              if (entry.isDirectory()) {
                walk(fullPath, fileList);
              } else {
                fileList.push(fullPath);
              }
            }
            return fileList;
          }

          const roots = ['static', 'content'];
          const files = roots.flatMap((r) => walk(r));

          (async () => {
            for (const file of files) {
              const ext = path.extname(file).toLowerCase();
              if (!exts.includes(ext)) continue;

              const avifPath = file.replace(/\.(jpg|jpeg|png)$/i, '.avif');
              if (fs.existsSync(avifPath)) {
                // AVIF already exists, skip
                continue;
              }

              console.log('Converting ' + file + ' -> ' + avifPath);
              try {
                await sharp(file)
                  .avif({ quality: 60 })
                  .toFile(avifPath);
              } catch (err) {
                console.error('Failed to convert ' + file + ':', err);
              }
            }
          })().catch(err => {
            console.error(err);
            process.exit(1);
          });
          EOF

      # ðŸ”§ NEW: remove Node junk so we only commit AVIFs
      - name: Clean up Node artifacts
        run: |
          rm -rf node_modules package.json package-lock.json

      - name: Commit and push AVIF files (if any)
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

            # pull latest main so push isn't rejected if you committed while this ran
            git pull --rebase origin main

            git add .
            git commit -m "Generate AVIF images"
            git push
          else
            echo "No new AVIF files to commit."
          fi
