{{- $src := .Get "src" -}}
{{- $alt := .Get "alt" | default "" -}}
{{- $caption := .Get "caption" | default "" -}}
{{- $class := .Get "class" | default "" -}}

{{- /* Prefer page resources (your content bundles) */ -}}
{{- $img := .Page.Resources.GetMatch $src -}}

{{- /* Compute URLs (prefer AVIF if it exists next to the JPG/PNG) */ -}}
{{- $jpgURL := "" -}}
{{- $avifURL := "" -}}

{{- if $img -}}
  {{- $jpgURL = $img.RelPermalink -}}
  {{- $avifName := (replaceRE "\\.(?i)(jpg|jpeg|png)$" ".avif" $img.Name) -}}
  {{- $avif := .Page.Resources.GetMatch $avifName -}}
  {{- if $avif -}}
    {{- $avifURL = $avif.RelPermalink -}}
  {{- end -}}
{{- else -}}
  {{- /* Fallback for static/ usage (not your main case, but safe) */ -}}
  {{- $jpgURL = ($src | relURL) -}}
  {{- $avifURL = (replaceRE "\\.(?i)(jpg|jpeg|png)$" ".avif" $jpgURL) -}}
{{- end -}}

<figure{{ if $class }} class="{{ $class }}"{{ end }}>
  <picture>
    {{- if $avifURL -}}
      <source srcset="{{ $avifURL }}" type="image/avif">
    {{- end -}}
    <img src="{{ $jpgURL }}" alt="{{ $alt }}" loading="lazy" decoding="async">
  </picture>

  {{- if $caption -}}
    <figcaption>{{ $caption | markdownify }}</figcaption>
  {{- end -}}
</figure>
